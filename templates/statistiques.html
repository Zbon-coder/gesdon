{% extends "base.html" %}

{% block title %}Statistiques - GesDon{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-4xl font-bold text-white mb-2">
        <i class="bi bi-bar-chart-line"></i> Statistiques & Graphiques
    </h1>
    <p class="text-white/80 text-lg">Visualisez les données et tendances de vos dons</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="glass rounded-xl p-5 text-center transform hover:scale-105 transition-all duration-300">
        <i class="bi bi-gift text-4xl text-purple-600 mb-2"></i>
        <p class="text-3xl font-bold text-gray-900">{{ stats.total_dons }}</p>
        <p class="text-sm text-gray-600 mt-1">Total Dons</p>
    </div>

    <div class="glass rounded-xl p-5 text-center transform hover:scale-105 transition-all duration-300">
        <i class="bi bi-people text-4xl text-blue-600 mb-2"></i>
        <p class="text-3xl font-bold text-gray-900">{{ stats.total_donateurs }}</p>
        <p class="text-sm text-gray-600 mt-1">Donateurs</p>
    </div>

    <div class="glass rounded-xl p-5 text-center transform hover:scale-105 transition-all duration-300">
        <i class="bi bi-building text-4xl text-green-600 mb-2"></i>
        <p class="text-3xl font-bold text-gray-900">{{ stats.total_associations }}</p>
        <p class="text-sm text-gray-600 mt-1">Associations</p>
    </div>

    <div class="glass rounded-xl p-5 text-center transform hover:scale-105 transition-all duration-300">
        <i class="bi bi-calendar-month text-4xl text-orange-600 mb-2"></i>
        <p class="text-3xl font-bold text-gray-900">{{ stats.dons_mois }}</p>
        <p class="text-sm text-gray-600 mt-1">Ce Mois</p>
    </div>

    <div class="glass rounded-xl p-5 text-center transform hover:scale-105 transition-all duration-300">
        <i class="bi bi-calendar-week text-4xl text-pink-600 mb-2"></i>
        <p class="text-3xl font-bold text-gray-900">{{ stats.dons_semaine }}</p>
        <p class="text-sm text-gray-600 mt-1">Cette Semaine</p>
    </div>
</div>

<!-- Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Évolution des dons (12 mois) -->
    <div class="glass rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-purple-600 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="bi bi-graph-up mr-2"></i> Évolution des Dons (12 mois)
            </h2>
        </div>
        <div class="p-6">
            <canvas id="evolutionMoisChart" class="w-full" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Dons par Association -->
    <div class="glass rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-purple-600 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="bi bi-pie-chart mr-2"></i> Dons par Association
            </h2>
        </div>
        <div class="p-6">
            <canvas id="donsAssociationChart" class="w-full" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Top Donateurs -->
    <div class="glass rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-purple-600 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="bi bi-trophy mr-2"></i> Top 10 Donateurs
            </h2>
        </div>
        <div class="p-6">
            <canvas id="topDonateursChart" class="w-full" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <!-- Évolution 7 derniers jours -->
    <div class="glass rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-purple-600 px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="bi bi-calendar-week mr-2"></i> Évolution (7 derniers jours)
            </h2>
        </div>
        <div class="p-6">
            <canvas id="evolutionSemaineChart" class="w-full" style="max-height: 300px;"></canvas>
        </div>
    </div>
</div>

<!-- Insights Section -->
<div class="glass rounded-2xl shadow-xl p-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
        <i class="bi bi-lightbulb mr-2 text-yellow-500"></i> Insights & Analyse
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
            <h3 class="font-semibold text-blue-900 mb-2">Tendance Mensuelle</h3>
            <p class="text-sm text-blue-800">Les dons de ce mois représentent <strong>{{ "%.1f"|format((stats.dons_mois / stats.total_dons * 100) if stats.total_dons > 0 else 0) }}%</strong> du total.</p>
        </div>
        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
            <h3 class="font-semibold text-green-900 mb-2">Activité Hebdomadaire</h3>
            <p class="text-sm text-green-800">Cette semaine a enregistré <strong>{{ stats.dons_semaine }}</strong> don{{ 's' if stats.dons_semaine > 1 else '' }}.</p>
        </div>
        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-lg">
            <h3 class="font-semibold text-purple-900 mb-2">Performance Globale</h3>
            <p class="text-sm text-purple-800">Moyenne de <strong>{{ "%.1f"|format(stats.total_dons / 12) }}</strong> dons par mois.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Configuration des couleurs
const colors = {
    purple: 'rgba(102, 126, 234, 0.8)',
    pink: 'rgba(240, 147, 251, 0.8)',
    blue: 'rgba(59, 130, 246, 0.8)',
    green: 'rgba(34, 197, 94, 0.8)',
    orange: 'rgba(249, 115, 22, 0.8)',
    red: 'rgba(239, 68, 68, 0.8)',
    yellow: 'rgba(234, 179, 8, 0.8)',
    gradient: [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(240, 147, 251, 0.8)',
        'rgba(79, 172, 254, 0.8)',
        'rgba(34, 197, 94, 0.8)',
        'rgba(249, 115, 22, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(234, 179, 8, 0.8)',
        'rgba(168, 85, 247, 0.8)',
        'rgba(236, 72, 153, 0.8)'
    ]
};

// Données passées depuis le backend
const donsParMois = {{ dons_par_mois | safe }};
const donsParAssociation = {{ dons_par_association | safe }};
const topDonateurs = {{ top_donateurs | safe }};
const evolutionSemaine = {{ evolution_semaine | safe }};

// Chart 1: Évolution des dons sur 12 mois
const ctxEvolutionMois = document.getElementById('evolutionMoisChart').getContext('2d');
new Chart(ctxEvolutionMois, {
    type: 'line',
    data: {
        labels: donsParMois.map(d => d.mois),
        datasets: [{
            label: 'Nombre de dons',
            data: donsParMois.map(d => d.nombre),
            borderColor: colors.purple,
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: colors.purple,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: colors.purple,
                borderWidth: 1
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Chart 2: Dons par Association (Doughnut)
const ctxAssociation = document.getElementById('donsAssociationChart').getContext('2d');
new Chart(ctxAssociation, {
    type: 'doughnut',
    data: {
        labels: donsParAssociation.map(d => d.nom),
        datasets: [{
            data: donsParAssociation.map(d => d.nombre),
            backgroundColor: colors.gradient,
            borderColor: '#fff',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    },
                    usePointStyle: true
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff'
            }
        }
    }
});

// Chart 3: Top Donateurs (Bar horizontal)
const ctxDonateurs = document.getElementById('topDonateursChart').getContext('2d');
new Chart(ctxDonateurs, {
    type: 'bar',
    data: {
        labels: topDonateurs.map(d => d.nom),
        datasets: [{
            label: 'Nombre de dons',
            data: topDonateurs.map(d => d.nombre),
            backgroundColor: colors.gradient.slice(0, topDonateurs.length),
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff'
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            y: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Chart 4: Évolution 7 derniers jours (Area)
const ctxSemaine = document.getElementById('evolutionSemaineChart').getContext('2d');

// Générer les 7 derniers jours
const derniersSept = [];
for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    derniersSept.push(date.toISOString().split('T')[0]);
}

// Mapper les données aux 7 derniers jours
const donsSemaine = derniersSept.map(jour => {
    const found = evolutionSemaine.find(d => d.jour === jour);
    return found ? found.nombre : 0;
});

new Chart(ctxSemaine, {
    type: 'line',
    data: {
        labels: derniersSept.map(d => {
            const date = new Date(d);
            return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Dons par jour',
            data: donsSemaine,
            borderColor: colors.green,
            backgroundColor: 'rgba(34, 197, 94, 0.2)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: colors.green,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: colors.green,
                borderWidth: 1
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});
</script>
{% endblock %}
